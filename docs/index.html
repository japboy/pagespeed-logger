<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>psi-json</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.7.1/d3.min.js"></script>
    <script defer>
      (function (window, document, d3) {
        document.addEventListener('DOMContentLoaded', function load (ev) {

          document.removeEventListener(ev.type, load);
          console.log('Hello, ', d3);

          function psDataJson (path) {
            return new Promise(function (resolve, reject) {
              d3.json(path, function (d) {
                d.timestamp = path.slice(0, 13);
                d.score = d.ruleGroups.SPEED.score;
                resolve(d);
              });
            });
          }

          const svg = d3.select('svg');
          const margin = { top: 20, right: 20, bottom: 30, left: 50 };
          const width = svg.attr('width') - margin.left - margin.right;
          const height = svg.attr('height') - margin.top - margin.bottom;
          const g = svg.append('g').attr('transform', 'translate(' + margin.left + ','  + margin.top + ')');

          const x = d3.scaleTime().rangeRound([ 0, width ]);
          const y = d3.scaleLinear().rangeRound([ height, 0 ]);
          const line = d3.line()
          .x(function (d) { return x(d.timestamp); })
          .y(function (d) { return y(d.score); });

          d3.json('./list.json', function (paths) {
            const requests = paths.map(psDataJson);
            Promise.all(requests)
            .then(function (data) {
              console.log(data);

              x.domain(d3.extent(data, function (d) { return d.timestamp; }));
              y.domain(d3.extent(data, function (d) { return d.score; }));

              g.append('g')
              .attr('transform', 'translate(0, ' + height + ')')
              .call(d3.axisBottom(x))
              .select('.domain')
              .remove();

              g.append("g")
              .call(d3.axisLeft(y))
              .append("text")
              .attr("fill", "#000")
              .attr("transform", "rotate(-90)")
              .attr("y", 6)
              .attr("dy", "0.71em")
              .attr("text-anchor", "end")
              .text("Score");

              g.append("path")
              .datum(data)
              .attr("fill", "none")
              .attr("stroke", "steelblue")
              .attr("stroke-linejoin", "round")
              .attr("stroke-linecap", "round")
              .attr("stroke-width", 1.5)
              .attr("d", line);


            }, function (error) {
              console.error(error.message);
            });
          });

        });
      })(window, document, d3);
    </script>
  </head>
  <body>
    <svg width="960" height="500"></svg>
  </body>
</html>
